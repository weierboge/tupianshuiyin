<html>
<head>
    <style>
        body {
            font-family: "黑体", Arial, Helvetica, sans-serif;
            background-color: white;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            color: #333;
            font-size: 36px;
            margin-top: 50px;
        }

        .container {
            width: 800px;
            margin: 50px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input {
            margin-top: 20px;
        }

        .input label {
            display: block;
            font-size: 18px;
            color: #333;
            border: 1px solid #ccc;
            padding: 5px;
        }

        .input input[type="file"] {
            display: none;
        }

        .input button {
            width: 200px;
            height: 50px;
            border: none;
            border-radius: 25px;
            background-color: #e6f7ff;
            color: #1890ff;
            font-size: 18px;
            cursor: pointer;
        }

        .input button:hover {
            background-color: #bae7ff;
        }

        .output {
            margin-top: 20px;
            display: flex;
            align-items: center;
        }

        .output label {
            display: block;
            font-size: 18px;
            color: #333;
            border: 1px solid #ccc;
            padding: 5px;
        }

        .output canvas {
            width: 600px;
            height: 400px;
            border: 3px solid #333; // 加上深色边框
        }

        .output button {
            width: 200px;
            height: 50px;
            border: none;
            border-radius: 25px;
            background-color: #e6f7ff;
            color: #1890ff;
            font-size: 18px;
            cursor: pointer;
        }

        .output button:hover {
            background-color: #bae7ff;
        }

        .settings {
            margin-left: 20px;
        }

        .settings label {
            display: block;
            font-size: 18px;
            color: #333;
            border: 1px solid #ccc;
            padding: 5px;
        }

        .settings input[type="text"] {
            width: 100px;
            height: 30px;
            border-radius: 5px; 
        }

        .settings input[type="range"] {
            width: 200px;
            height: 30px;
        }
    </style>
</head>
<body>
    <h1>图片加水印工具</h1>
    <div class="container">
        <div class="input">
          <label for="file">选择图片</label>
          <input type="file" id="file" accept="image/*" onchange="loadImage()">
          <button id="upload">上传图片</button>
      </div>
      <div class="output">
          <div class="preview">
              <label for="canvas">预览效果</label>
              <canvas id="canvas"></canvas>
              <button id="download">生成图片</button>
          </div>
          <div class="settings">
              <label for="text">水印文字</label>
              <input type="text" id="text" value="Bing" onchange="drawWatermark()">
              <label for="number">水印数量</label>
              <input type="range" id="number" value="5" min="1" max="100" onchange="drawWatermark()">
              <label for="size">水印大小</label>
              <input type="range" id="size" value="50" min="10" max="100" onchange="drawWatermark()">
              <label for="angle">水印角度</label>
              <input type="range" id="angle" value="-45" min="-90" max="90" onchange="drawWatermark()">
              <label for="opacity">水印透明度</label> // 增加水印透明度选项
              <input type="range" id="opacity" value="0.5" min="0" max="1" step ="0.01" onchange ="drawWatermark()"> // 增加水印透明度选项
          </div>
      </div>
    </div>

    <script>
      // 获取元素
      var file = document.getElementById("file");
      var upload = document.getElementById("upload");
      var canvas = document.getElementById("canvas");
      var download = document.getElementById("download");
      var text = document.getElementById("text");
      var number = document.getElementById("number");
      var size = document.getElementById("size");
      var angle = document.getElementById("angle");
      var opacity = document.getElementById("opacity"); // 获取水印透明度元素

      // 创建图片对象
      var image = new Image();

      // 创建画布上下文
      var ctx = canvas.getContext("2d");

      // 加载图片
      function loadImage() {
        // 获取文件对象
        var fileObj = file.files[0];
        // 创建文件读取器
        var reader = new FileReader();
        // 读取文件为数据URL
        reader.readAsDataURL(fileObj);
        // 监听读取完成事件
        reader.onload = function() {
          // 设置图片源为数据URL
          image.src = this.result;
          // 监听图片加载事件
          image.onload = function() {
            // 绘制图片到画布
            drawImage();
            // 绘制水印到画布
            drawWatermark();
          }
        }
      }

      // 绘制图片
      function drawImage() {
        // 清空画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // 计算图片缩放比例
        var scale = Math.min(canvas.width / image.width, canvas.height / image.height);
        // 计算图片绘制位置和大小
        var x = (canvas.width - image.width * scale) / 2;
        var y = (canvas.height - image.height * scale) / 2;
        var w = image.width * scale;
        var h = image.height * scale;
        // 绘制图片到画布
        ctx.drawImage(image, x, y, w, h);
      }

      // 绘制水印
      function drawWatermark() {
        // 清空画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // 重新绘制图片
        drawImage();
        // 获取水印文字
        var txt = text.value;
        // 获取水印数量
        var num = number.value;
        // 获取水印大小
        var s = size.value;
        // 获取水印角度（转换为弧度）
        var a = angle.value * Math.PI / 180;
        // 获取水印透明度 // 获取水印透明度
        var o = opacity.value; // 获取水印透明度
        // 设置字体样式
        ctx.font = s + "px Arial";
        // 设置字体颜色（根据透明度） // 设置字体颜色（根据透明度）
        ctx.fillStyle = "rgba(0, 0, 0, " + o + ")"; // 设置字体颜色（根据透明度）
        // 设置文本对齐方式（居中）
        ctx.textAlign = "center";
        // 设置文本基线（中间）
        ctx.textBaseline = "middle";
        
        // 计算水印间隔（根据角度和大小）
        var dx = s * Math.cos(a);
        var dy = s * Math.sin(a);

        // 计算水印行数和列数（根据图片尺寸和水印数量）
        var rows = Math.ceil(Math.sqrt(num));
        var cols = Math.ceil(num / rows);

        // 遍历水印行数和列数，绘制每个水印
        for (var i = 0; i < rows; i++) {
          for (var j = 0; j < cols; j++) {
            // 计算水印索引
            var index = i * cols + j;
            // 如果索引超过水印数量，跳出循环
            if (index >= num) break;
            // 计算水印位置（根据索引和间隔）
            var x = image.width / 2 + (j - (cols - 1) / 2) * dx;
            var y = image.height / 2 + (i - (rows - 1) / 2) * dy;

            // 保存画布状态
            ctx.save();
            // 移动画布原点到水印位置
            ctx.translate(x, y);
            // 旋转画布到水印角度
            ctx.rotate(a);
            // 绘制水印文字到画布
            ctx.fillText(txt, 0, 0);
            // 恢复画布状态
            ctx.restore();
          }
        }
      }

      // 上传图片
      upload.onclick = function() {
        // 触发文件选择器的点击事件
        file.click();
      }

      // 生成图片
      download.onclick = function() {
        // 创建一个新的画布，用于输出图片
        var outputCanvas = document.createElement("canvas");
        // 设置新画布的尺寸为图片的原始尺寸
        outputCanvas.width = image.width;
        outputCanvas.height = image.height;
        ctx.textAlign = "center";
        // 设置文本基线（中间）
        ctx.textBaseline = "middle";
        
        // 计算水印间隔（根据角度和大小）
        var dx = s * Math.cos(a);
        var dy = s * Math.sin(a);


        // 计算水印行数和列数（根据图片尺寸和水印数量）
        var rows = Math.ceil(Math.sqrt(num));
        var cols = Math.ceil(num / rows);


        // 遍历水印行数和列数，绘制每个水印
        for (var i = 0; i < rows; i++) {
          for (var j = 0; j < cols; j++) {
            // 计算水印索引
            var index = i * cols + j;
            // 如果索引超过水印数量，跳出循环
            if (index >= num) break;
            // 计算水印位置（根据索引和间隔）
            var x = image.width / 2 + (j - (cols - 1) / 2) * dx;
            var y = image.height / 2 + (i - (rows - 1) / 2) * dy;


            // 保存画布状态
            ctx.save();
            // 移动画布原点到水印位置
            ctx.translate(x, y);
            // 旋转画布到水印角度
            ctx.rotate(a);
            // 绘制水印文字到画布
            ctx.fillText(txt, 0, 0);
            // 恢复画布状态
            ctx.restore();
          }
        }
      }


      // 上传图片
      upload.onclick = function() {
        // 触发文件选择器的点击事件
        file.click();
      }


      // 生成图片
      download.onclick = function() {
        // 创建一个新的画布，用于输出图片
        var outputCanvas = document.createElement("canvas");
         Set the size of the new canvas to the original size of the picture
        outputCanvas.width = image.width;
        outputCanvas.height = image.height;
        ctx.textAlign = "center";
        // 设置文本基线（中间）
        ctx.textBaseline = "middle";
        
        // 计算水印间隔（根据角度和大小）
        var dx = s * Math.cos(a);
        var dy = s * Math.sin(a);


        // 计算水印行数和列数（根据图片尺寸和水印数量）
        var rows = Math.ceil(Math.sqrt(num));
        var cols = Math.ceil(num / rows);


        // 遍历水印行数和列数，绘制每个水印
        for (var i = 0; i < rows; i++) {
          for (var j = 0; j < cols; j++) {
            // 计算水印索引
            var index = i * cols + j;
            // 如果索引超过水印数量，跳出循环
            if (index >= num) break;
            // 计算水印位置（根据索引和间隔）
            var x = image.width / 2 + (j - (cols - 1) / 2) * dx;
            var y = image.height / 2 + (i - (rows - 1) / 2) * dy;


            // 保存画布状态
            ctx.save();
            // 移动画布原点到水印位置
            ctx.translate(x, y);
            // 旋转画布到水印角度
            ctx.rotate(a);
            // 绘制水印文字到画布
            ctx.fillText(txt, 0, 0);
            // 恢复画布状态
            ctx.restore();
          }
        }
      }


      // 上传图片
      upload.onclick = function() {
        // 触发文件选择器的点击事件
        file.click();
      }


// 生成图片
      download.onclick = function() {
        // 创建一个新的画布，用于输出图片
        var outputCanvas = document.createElement("canvas");
        // 设置新画布的尺寸为图片的原始尺寸
        outputCanvas.width = image.width;
        outputCanvas.height = image.height;
        // 获取新画布的上下文
        var outputCtx = outputCanvas.getContext("2d");
        // 绘制图片到新画布
        outputCtx.drawImage(image, 0, 0);
        // 绘制水印到新画布
        drawWatermarkToOutput(outputCtx);
        // 获取新画布的数据URL
        var dataURL = outputCanvas.toDataURL();
        // 创建下载链接
        var link = document.createElement("a");
        // 设置下载链接的属性
        link.href = dataURL;
        link.download = "watermarked-image.png";
        // 触发下载链接的点击事件
        link.click();
      }

      // 绘制水印到输出画布
      function drawWatermarkToOutput(outputCtx) {
        // 获取水印文字
        var txt = text.value;
        // 获取水印数量
        var num = number.value;
        // 获取水印大小
        var s = size.value;
        // 获取水印角度（转换为弧度）
        var a = angle.value * Math.PI / 180;
        // 获取水印透明度 // 获取水印透明度
        var o = opacity.value; // 获取水印透明度
        // 设置字体样式
        outputCtx.font = s + "px Arial";
        // 设置字体颜色（根据透明度） // 设置字体颜色（根据透明度）
        outputCtx.fillStyle = "rgba(0, 0, 0, " + o + ")"; // 设置字体颜色（根据透明度）
        // 设置文本对齐方式（居中）
        outputCtx.textAlign = "center";
        // 设置文本基线（中间）
        outputCtx.textBaseline = "middle";
        
        // 计算水印间隔（根据角度和大小）
        var dx = s * Math.cos(a);
        var dy = s * Math.sin(a);

        // 计算水印行数和列数（根据图片尺寸和水印数量）
        var rows = Math.ceil(Math.sqrt(num));
        var cols = Math.ceil(num / rows);

        // 遍历水印行数和列数，绘制每个水印
        for (var i = 0; i < rows; i++) {
          for (var j = 0; j < cols; j++) {
            // 计算水印索引
            var index = i * cols + j;
            // 如果索引超过水印数量，跳出循环
            if (index >= num) break;
            // 计算水印位置（根据索引和间隔）
            var x = image.width / 2 + (j - (cols - 1) / 2) * dx;
            var y = image.height / 2 + (i - (rows - 1) / 2) * dy;

            // 保存画布状态
            outputCtx.save();
            // 移动画布原点到水印位置
            outputCtx.translate(x, y);
            // 旋转画布到水印角度
            outputCtx.rotate(a);
            // 绘制水印文字到画布
            outputCtx.fillText(txt, 0, 0);
            // 恢复画布状态
            outputCtx.restore();
          }
        }
      }
    </script>
</body>
</html>
